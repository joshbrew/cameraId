var __require=(x=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(x,{get:(a,b)=>(typeof require!=="undefined"?require:a)[b]}):x)(function(x){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+x+'" is not supported')});var BoundingBoxTool=class{sourceElement;overlayCanvas;ctx;options;boxes;isDrawing;startX;startY;currentBox;currentBoxIndex;isResizing=false;resizingEdge;justFocused=false;resizeObserver;originalWidth;originalHeight;constructor(sourceElement,options){this.sourceElement=sourceElement;this.overlayCanvas=options.overlayCanvas?options.overlayCanvas:document.createElement("canvas");if(!options.overlayCanvas)sourceElement.parentNode?.appendChild(this.overlayCanvas);this.ctx=this.overlayCanvas.getContext("2d");this.options=options||{};this.boxes=[];this.overlayCanvas.addEventListener("mousedown",e=>this.handleMouseDown(e));this.overlayCanvas.addEventListener("mousemove",e=>this.handleMouseMove(e));this.overlayCanvas.addEventListener("mouseup",e=>this.handleMouseUp(e));this.overlayCanvas.style.cursor="crosshair";this.sourceElement.onload=()=>{this.overlayCanvas.width=this.sourceElement.width;this.overlayCanvas.height=this.sourceElement.height};this.resizeObserver=new ResizeObserver(entries=>{for(let entry of entries){if(entry.target===this.sourceElement){this.resizeCanvas()}}});this.originalWidth=sourceElement.offsetWidth;this.originalHeight=sourceElement.offsetHeight;this.resizeObserver.observe(this.sourceElement);this.sourceElement.addEventListener("click",()=>{this.resizeCanvas()});this.updateCanvasSize()}updateCanvasSize=()=>{const naturalWidth=this.sourceElement instanceof HTMLVideoElement&&this.sourceElement.videoWidth||this.sourceElement instanceof HTMLImageElement&&this.sourceElement.naturalWidth||this.sourceElement.width;const naturalHeight=this.sourceElement instanceof HTMLVideoElement&&this.sourceElement.videoHeight||this.sourceElement instanceof HTMLImageElement&&this.sourceElement.naturalHeight||this.sourceElement.height;const layoutWidth=this.sourceElement.clientWidth;const layoutHeight=this.sourceElement.clientHeight;const scaleX=layoutWidth/naturalWidth;const scaleY=layoutHeight/naturalHeight;const scale=Math.min(scaleX,scaleY);const scaleWidth=naturalWidth*scale;const scaleHeight=naturalHeight*scale;this.overlayCanvas.width=scaleWidth;this.overlayCanvas.height=scaleHeight;this.overlayCanvas.style.width=`${scaleWidth}px`;this.overlayCanvas.style.height=`${scaleHeight}px`;this.updateCanvasPosition()};updateCanvasPosition=()=>{this.overlayCanvas.style.position="absolute";this.overlayCanvas.style.left="50%";this.overlayCanvas.style.transform="translateX(-50%)"};updateBoxesAndLabels=()=>{const newWidth=this.sourceElement.offsetWidth;const newHeight=this.sourceElement.offsetHeight;const scaleX=newWidth/this.originalWidth;const scaleY=newHeight/this.originalHeight;this.boxes=this.boxes.map(box=>{const scaledX=box.rect.x*scaleX;const scaledY=box.rect.y*scaleY;const scaledWidth=box.rect.width*scaleX;const scaledHeight=box.rect.height*scaleY;const labelSpan=document.getElementById(`label_${box.id}`);if(labelSpan){labelSpan.style.left=`${scaledX}px`;labelSpan.style.top=`${scaledY-10}px`}return{...box,rect:{x:scaledX,y:scaledY,width:scaledWidth,height:scaledHeight}}});this.originalWidth=newWidth;this.originalHeight=newHeight;this.redrawCanvas()};resizeCanvas=()=>{this.updateCanvasSize();this.updateBoxesAndLabels()};findBoxEdge(mouseEvent){const mousePos={x:mouseEvent.offsetX,y:mouseEvent.offsetY};const threshold=10;for(let i=this.boxes.length-1;i>=0;i--){const box=this.boxes[i].rect;const edge=this.getResizingEdge(mousePos,box,threshold);if(Object.values(edge).includes(true)){this.resizingEdge=edge;return i}}return-1}handleMouseDown(event){if(this.justFocused){this.justFocused=false;return}const canvasRect=this.overlayCanvas.getBoundingClientRect();this.startX=event.clientX-canvasRect.left;this.startY=event.clientY-canvasRect.top;const clickedBoxIndex=this.findBoxEdge(event);if(clickedBoxIndex!==-1){this.isDrawing=false;this.isResizing=true;this.currentBoxIndex=clickedBoxIndex;this.currentBox=this.boxes[clickedBoxIndex]}else{this.isDrawing=true}}handleMouseMove(event){const canvasRect=this.overlayCanvas.getBoundingClientRect();const mouseX=event.clientX-canvasRect.left;const mouseY=event.clientY-canvasRect.top;if(this.isResizing){this.resizeBox({offsetX:mouseX,offsetY:mouseY},this.currentBox.rect,this.resizingEdge);this.redrawCanvas()}else if(this.isDrawing){this.redrawCanvas();this.drawBoundingBox(this.startX,this.startY,mouseX-this.startX,mouseY-this.startY)}}handleMouseUp(event){if(this.isResizing){this.isResizing=false;if(this.options.onedited){this.options.onedited(this.currentBox,this.boxes,this.sourceElement,this.overlayCanvas,this.ctx)}}else if(this.isDrawing){this.isDrawing=false;const canvasRect=this.overlayCanvas.getBoundingClientRect();const endX=event.clientX-canvasRect.left;const endY=event.clientY-canvasRect.top;if(Math.abs(endX-this.startX)>0&&Math.abs(endY-this.startY)>0){const newBox={rect:this.getBoundingBoxRect(this.startX,this.startY,endX,endY),label:"",id:`${Math.floor(Math.random()*1e15)}`};this.boxes.push(newBox);this.createLabelInput(newBox);this.redrawCanvas();if(this.options.oncreate){this.options.oncreate(newBox,this.boxes,this.sourceElement,this.overlayCanvas,this.ctx)}}}}getScale=()=>{const sourceWidth=this.sourceElement.naturalWidth||this.sourceElement.videoWidth||this.sourceElement.width;const sourceHeight=this.sourceElement.naturalHeight||this.sourceElement.videoHeight||this.sourceElement.height;return{x:sourceWidth/this.overlayCanvas.width,y:sourceHeight/this.overlayCanvas.height}};getInverseScale=()=>{const scale=this.getScale();return{x:1/scale.x,y:1/scale.y}};getBoundingBoxRect=(x0,y0,x1,y1)=>{const scale=this.getScale();let left=Math.min(x0,x1)*scale.x;let top=Math.min(y0,y1)*scale.y;let right=Math.max(x0,x1)*scale.x;let bottom=Math.max(y0,y1)*scale.y;return{x:left,y:top,width:right-left,height:bottom-top}};drawBoundingBox=(x,y,width,height)=>{this.ctx.beginPath();this.ctx.lineWidth=2;this.ctx.rect(x,y,width,height);this.ctx.strokeStyle=this.options.color||"orange";this.ctx.stroke()};redrawCanvas=()=>{this.ctx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);const inverseScale=this.getInverseScale();this.boxes.forEach(box=>{const scaledX=box.rect.x*inverseScale.x;const scaledY=box.rect.y*inverseScale.y;const scaledWidth=box.rect.width*inverseScale.x;const scaledHeight=box.rect.height*inverseScale.y;this.drawBoundingBox(scaledX,scaledY,scaledWidth,scaledHeight);if(box.label){this.drawLabel(box)}})};getResizingEdge(mousePos,boxRect,threshold){let edge={top:false,right:false,bottom:false,left:false};let scale=this.getInverseScale();const scaledBoxRect={x:boxRect.x*scale.x,y:boxRect.y*scale.y,width:boxRect.width*scale.x,height:boxRect.height*scale.y};const insideHorizontalBounds=mousePos.x>=scaledBoxRect.x*scale.x-threshold&&mousePos.x<=scaledBoxRect.x+scaledBoxRect.width+threshold;const insideVerticalBounds=mousePos.y>=scaledBoxRect.y-threshold&&mousePos.y<=scaledBoxRect.y+scaledBoxRect.height+threshold;if(insideHorizontalBounds){if(Math.abs(mousePos.y-scaledBoxRect.y)<threshold){edge.top=true}else if(Math.abs(scaledBoxRect.y+scaledBoxRect.height-mousePos.y)<threshold){edge.bottom=true}}if(insideVerticalBounds){if(Math.abs(mousePos.x-scaledBoxRect.x)<threshold){edge.left=true}else if(Math.abs(scaledBoxRect.x+scaledBoxRect.width-mousePos.x)<threshold){edge.right=true}}return edge}resizeBox=(mouseEvent,boxRect,resizingEdge)=>{const scale=this.getScale();const mouseX=mouseEvent.offsetX*scale.x;const mouseY=mouseEvent.offsetY*scale.y;const dx=mouseX-this.startX*scale.x;const dy=mouseY-this.startY*scale.y;if(resizingEdge.right){boxRect.width+=dx}else if(resizingEdge.left){boxRect.width-=dx;boxRect.x+=dx}if(resizingEdge.bottom){boxRect.height+=dy}else if(resizingEdge.top){boxRect.height-=dy;boxRect.y+=dy}if(boxRect.width<0){boxRect.x+=boxRect.width;boxRect.width=-boxRect.width}if(boxRect.height<0){boxRect.y+=boxRect.height;boxRect.height=-boxRect.height}this.updateLabelPosition(this.currentBox);this.startX=mouseEvent.offsetX;this.startY=mouseEvent.offsetY};updateLabelPosition=box=>{const scale=this.getInverseScale();const labelContainer=document.getElementById(`label_container_${box.id}`);if(labelContainer){let labelX=box.rect.x*scale.x;let labelY=box.rect.y*scale.y+10;if(labelY<20){labelY=box.rect.y*scale.y+box.rect.height*scale.y+10}labelX=Math.max(0,Math.min(labelX,this.overlayCanvas.width-labelContainer.offsetWidth));labelContainer.style.left=`${labelX}px`;labelContainer.style.top=`${labelY}px`}};drawLabel=box=>{let labelContainer=document.getElementById(`label_container_${box.id}`);if(!labelContainer){labelContainer=document.createElement("div");labelContainer.id=`label_container_${box.id}`;labelContainer.style.position="absolute";labelContainer.style.color=this.options.labelColor||"black";labelContainer.style.zIndex="1000";labelContainer.style.display="flex";labelContainer.style.alignItems="center";document.body.appendChild(labelContainer)}else{labelContainer.innerHTML=""}const scale=this.getInverseScale();let labelX=box.rect.x*scale.x;let labelY=box.rect.y*scale.y+10;if(labelY<20){labelY=box.rect.y*scale.y+box.rect.height*scale.y+10}labelX=Math.max(0,Math.min(labelX,this.overlayCanvas.width-labelContainer.offsetWidth));labelContainer.style.left=`${labelX}px`;labelContainer.style.top=`${labelY}px`;const deleteBtn=document.createElement("button");deleteBtn.textContent="X";deleteBtn.style.marginRight="5px";deleteBtn.onclick=()=>{this.deleteBox(box.id)};labelContainer.appendChild(deleteBtn);const labelSpan=document.createElement("span");labelSpan.textContent=box.label||"Edit";labelSpan.style.padding="2px 4px";labelSpan.style.cursor="text";labelSpan.style.minWidth="20px";labelSpan.onclick=()=>{const labelInput=document.createElement("input");labelInput.type="text";labelInput.value=box.label;labelInput.style.border="none";labelInput.style.padding="2px 4px";let keydownlistener=e=>{if(e.key==="Enter"){labelInput.blur()}};window.addEventListener("keydown",keydownlistener);labelInput.onblur=()=>{window.removeEventListener("keydown",keydownlistener);this.justFocused=false;const prevLabel=box.label;box.label=labelInput.value;labelSpan.textContent=box.label||"Edit";labelSpan.style.textShadow="1px 2px red, 0 0 1em blue, 0 0 0.2em blue";labelContainer.replaceChild(labelSpan,labelInput);this.redrawCanvas();if(prevLabel!==box.label&&this.options.onedited){this.options.onedited(box,this.boxes,this.sourceElement,this.overlayCanvas,this.ctx)}};labelInput.onfocus=()=>{this.justFocused=true};labelContainer.replaceChild(labelInput,labelSpan);labelInput.focus()};labelContainer.appendChild(labelSpan);return{labelContainer,labelSpan}};createLabelInput=box=>{let{labelSpan}=this.drawLabel(box);labelSpan.click()};updateLabelProgrammatically=(boxId,newLabel)=>{const labelContainer=document.getElementById(`label_container_${boxId}`);if(!labelContainer){return}const labelInput=labelContainer.querySelector("input");if(labelInput&&document.activeElement===labelInput){labelInput.blur()}const labelSpan=labelContainer.querySelector("span");if(!labelSpan){console.warn(`Label span for box ID ${boxId} not found.`);return}labelSpan.textContent=newLabel||"Edit";const boxIndex=this.boxes.findIndex(box=>box.id===boxId);if(boxIndex!==-1){this.boxes[boxIndex].label=newLabel;if(this.options.onedited){this.options.onedited(this.boxes[boxIndex],this.boxes,this.sourceElement,this.overlayCanvas,this.ctx)}}else{console.warn(`Box with ID ${boxId} not found.`)}};deleteBox=id=>{const index=this.boxes.findIndex(box=>box.id===id);if(index!==-1){let spliced=this.boxes.splice(index,1);const labelContainer=document.getElementById(`label_container_${id}`);if(labelContainer)document.body.removeChild(labelContainer);this.redrawCanvas();if(this.options.ondelete)this.options.ondelete(spliced[0],this.boxes,this.sourceElement,this.overlayCanvas,this.ctx)}};clearBoundingBoxes(deleteCanvas){this.boxes.forEach(box=>{const labelContainer=document.getElementById(`label_container_${box.id}`);if(labelContainer){document.body.removeChild(labelContainer)}});this.boxes=[];this.ctx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);if(deleteCanvas)this.deleteCanvas()}deleteCanvas(){if(this.overlayCanvas&&this.overlayCanvas.parentNode){this.overlayCanvas.parentNode.removeChild(this.overlayCanvas)}if(this.resizeObserver){this.resizeObserver.unobserve(this.sourceElement);this.resizeObserver=void 0}}};var MediaElementCreator=class{fileInput;videoSelect;parentElement;mediaOptions;currentMediaElement=null;oncreate;onstarted;ondelete;onended;ontargetchanged;constructor(parentElement,callbacks,mediaOptions,autostart=true){this.parentElement=parentElement;this.mediaOptions=mediaOptions||{audio:false,video:{optional:[{minWidth:320},{minWidth:640},{minWidth:1024},{minWidth:1280},{minWidth:1920},{minWidth:2560},{minWidth:3840}]}};this.oncreate=callbacks?.oncreate;this.onstarted=callbacks?.onstarted;this.ondelete=callbacks?.ondelete;this.ontargetchanged=callbacks?.ontargetchanged;let controlsDiv=document.createElement("div");this.parentElement.appendChild(controlsDiv);this.createFileInputElement(controlsDiv);this.createVideoSelectElement(controlsDiv);if(autostart)setTimeout(()=>{if(this.videoSelect.value)this.getVideoStream({audio:false,video:{width:{min:480,ideal:3840},height:{min:320,ideal:2160},deviceId:this.videoSelect.value}})},100)}createFileInputElement(parent){this.fileInput=document.createElement("input");this.fileInput.type="file";this.fileInput.accept="image/*, video/*";this.fileInput.addEventListener("change",event=>{const target=event.target;if(target.files&&target.files[0]){const file=target.files[0];this.createMediaElement(file)}});this.fileInput.onclick=ev=>{this.fileInput.value=""};parent.appendChild(this.fileInput)}createVideoSelectElement(parent){this.videoSelect=document.createElement("select");this.setupVideoInputOptions();parent.appendChild(this.videoSelect);let button=document.createElement("button");button.innerHTML="Stream";button.onclick=()=>{this.setStream()};parent.appendChild(button)}setStream=()=>{const options={...this.mediaOptions,video:{width:{min:480,ideal:3840},height:{min:320,ideal:2160},deviceId:this.videoSelect.value}};this.getVideoStream(options)};async setupVideoInputOptions(){const devices=await navigator.mediaDevices.enumerateDevices();const videoDevices=devices.filter(device=>device.kind==="videoinput");this.videoSelect.innerHTML=videoDevices.map(device=>`<option value="${device.deviceId}">${device.label||device.deviceId}</option>`).join("");this.videoSelect.addEventListener("change",this.setStream)}async getVideoStream(options){try{const stream=await navigator.mediaDevices.getUserMedia(options);this.createVideoElement(stream,options?.video?.deviceId)}catch(error){console.error("Error accessing the webcam",error)}}createMediaElement(file){const url2=URL.createObjectURL(file);if(this.oncreate)this.oncreate(file.name,null);if(file.type.startsWith("image/")){this.createImageElement(url2)}else if(file.type.startsWith("video/")){this.createVideoElement(url2)}else{console.error("Unsupported file type:",file.type)}}createImageElement(src){const image=new Image;image.src=src;image.onload=()=>{this.deinitMediaElement();this.parentElement.appendChild(image);this.currentMediaElement=image;if(this.ontargetchanged)this.ontargetchanged(src,image)}}createVideoElement(src,deviceId){this.deinitMediaElement();const video=document.createElement("video");video.classList.add("video-element");video.autoplay=true;video.loop=true;video.muted=true;if(typeof src==="string"){video.src=src;if(this.oncreate)this.oncreate(src,video)}else{video.srcObject=src;video.onloadedmetadata=()=>{if(this.onstarted)this.onstarted(deviceId,video)}}video.onplay=()=>{if(this.onstarted)this.onstarted(deviceId||video.src,video)};video.onended=()=>{if(this.onended)this.onended(video.src||deviceId,video)};const videoContainer=document.createElement("div");videoContainer.className="video-container";videoContainer.appendChild(video);if(!deviceId){const controlsDiv=document.createElement("div");controlsDiv.className="video-controls";const playPauseBtn=document.createElement("button");playPauseBtn.innerText="\u23F8\uFE0F";playPauseBtn.onclick=()=>{if(video.paused){video.play();playPauseBtn.innerText="\u23F8\uFE0F"}else{video.pause();playPauseBtn.innerText="\u25B6\uFE0F"}};const seekSlider=document.createElement("input");seekSlider.type="range";seekSlider.min="0";seekSlider.max="100";seekSlider.value="0";seekSlider.oninput=e=>{const seekTo=video.duration*(+seekSlider.value/100);video.currentTime=seekTo};video.ontimeupdate=()=>{seekSlider.value=String(video.currentTime/video.duration*100)};controlsDiv.appendChild(playPauseBtn);controlsDiv.appendChild(seekSlider);videoContainer.appendChild(controlsDiv)}videoContainer.appendChild(video);this.parentElement.appendChild(videoContainer);this.currentMediaElement=video;if(this.ontargetchanged)this.ontargetchanged(deviceId||video.src,video)}deinitMediaElement(){if(this.currentMediaElement){if(this.currentMediaElement instanceof HTMLVideoElement&&this.currentMediaElement.srcObject){const tracks=this.currentMediaElement.srcObject.getTracks();tracks.forEach(track=>track.stop())}if(this.ondelete)this.ondelete(this.currentMediaElement.src||this.currentMediaElement.srcObject,this.currentMediaElement);this.currentMediaElement.remove();this.currentMediaElement=null}}};function C(s=W=>W,{imports:R,message:g,transfer:r,port:n,blocking:l,pool:f,loop:u,animate:y,callback:P}={}){return new Promise((W,S)=>{let O;if(typeof s!="function"){if(typeof s=="string"&&s.startsWith("./")){let i=location.origin,t=location.pathname.split("/");t.pop();let c=t.join("/");c.startsWith("http")?i+="/":i+=c+"/",s=i+s}O=s}else O=I(s,R);let M=i=>{let t={},c=false;i.onmessage=a=>{for(let e in t)t[e](a.data.message,a.data.cb)},i.onerror=a=>{console.error(new Error("Worker encountered an error: "+a.message))};let d=(a,e,o)=>new Promise((b,p2)=>{if(!o&&i.PORTS)i.postMessage({message:a,overridePort:o},e),b(true);else{if(l){if(c)return new Promise((h,T)=>{T("Thread Blocked")});c=true}let E=Math.random();t[E]=(h,T)=>{E===T&&(delete t[E],l&&(c=false),b(h))},i.postMessage({message:a,cb:E,overridePort:o},e)}}),m={run:(a,e,o)=>d(a,e,o),terminate:()=>{if(URL.revokeObjectURL(O),i.terminate(),i.PORTS){let a=(e,o)=>{e.postMessage({COMMAND:{DELETED:i.id}})};i.PORTS.forEach(a)}},addPort:a=>k(i,a,l),addCallback:(a=o=>{},e)=>{let o=Math.random();return t[o]=e?b=>{a(b),delete t[o]}:a,o},removeCallback:a=>{delete m.callbacks[a]},setLoop:(a,e,o)=>{i.postMessage({message:e,COMMAND:{SETLOOP:a}},o)},setAnimation:(a,e)=>{i.postMessage({message:a,COMMAND:{SETANIM:true}},e)},stop:()=>{i.postMessage({COMMAND:{STOP:true}})},worker:i,callbacks:t,id:i.id};return P&&m.addCallback(P),u?m.setLoop(u,g,r):y&&m.setAnimation(g,r),m};if(f){let c=function(){let m=new Worker(O,R||typeof s!="function"?{type:"module"}:void 0),a=Math.random();return m.id=a,i[a]=m,a},i={},t={};for(let m=0;m<f;m++)c();let d=Object.keys(i);if(n&&d.forEach((m,a)=>{let e=i[m];Array.isArray(n)?n.length===d.length?k(e,n[a],l):n.forEach(o=>{k(e,o,l)}):k(e,n,l)}),g&&!u&&!y)Promise.all(d.map((m,a)=>{let e=i[m],o=Array.isArray(g)?g[a]:g;return new Promise((b,p2)=>{e.onmessage=h=>{Promise.resolve().then(()=>{e.terminate(),delete i[e.id]}),b(h.data.message)},e.onerror=h=>{Promise.resolve().then(()=>{e.terminate(),delete i[e.id]}),p2(new Error("Worker encountered an error: "+h.message))};let E={message:o,oneOff:true};e.postMessage(E,r)})})).then(m=>{URL.revokeObjectURL(O),W(m)}).catch(m=>{URL.revokeObjectURL(O),Object.keys(i).map((a,e)=>{let o=i[a];o&&o.terminate(),delete i[a],delete t.helpers?.[a]}),S(m)});else{let m=0;Object.assign(t,{workers:i,helpers:{},keys:d,run:(e,o,b,p2)=>{if(p2)return t.helpers[p2]?.run(e,o);if(Array.isArray(e)){let E=e.length,h=[];for(let T=0;T<E;T++){let K=t.helpers[d[m]].run(e[T],o[T],b);m++,m>=d.length&&(m=0),h.push(K)}return h}else{let E=t.helpers[d[m]].run(e,o,b);return m++,m>=d.length&&(m=0),E}},terminate:e=>{function o(b){t.helpers[b]?.terminate(),delete t.helpers[b],delete t.workers[b]}e?o(e):d.forEach(o)},addWorker:()=>{let e=c(),o=i[e];return a(o),d.length=0,d.push(...d),e},addPort:(e,o)=>{function b(p2){return t.helpers[p2]?.addPort(e),true}return o?b(o):d.map(b)},addCallback:(e,o,b)=>{function p2(E){return t.helpers[E]?.addCallback(e,o)}return b?p2(b):d.map(p2)},removeCallback:(e,o)=>{function b(p2){return t.helpers[p2]?.removeCallback(e),true}return o?b(o):d.map(b)},setLoop:(e,o,b,p2)=>{function E(h){t.helpers[h]?.setLoop(e,o,b)}return p2?E(p2):d.map(E)},setAnimation:(e,o,b)=>{function p2(E){t.helpers[E]?.setAnimation(e,o)}return b?p2(b):d.map(p2)},stop:e=>{function o(b){t.helpers[b]?.stop()}return e?o(e):d.map(o)}});let a=e=>{t.helpers[e.id]=M(e)};Object.keys(i).forEach((e,o)=>{a(i[e])}),W(t)}}else{let i=Math.random(),t=new Worker(O,R||typeof s!="function"?{type:"module"}:void 0);if(t.id=i,n&&(n.id||(n.id=Math.random()),Array.isArray(n)?n.map(c=>{k(t,c,l)}):k(t,n,l)),g&&!u&&!y)t.onmessage=c=>{Promise.resolve().then(()=>{t.terminate(),URL.revokeObjectURL(O)}),W(c.data.message)},t.onerror=c=>{Promise.resolve().then(()=>{t.terminate(),URL.revokeObjectURL(O)}),S(new Error("Worker encountered an error: "+c.message))},t.postMessage({message:g,oneOff:true},r);else{let c=M(t);W(c)}}})}function D(s){let R=location.pathname.split("/");R.pop();let g=location.origin+R.join("/")+"/";return typeof s=="string"?(s.startsWith("./")&&(s=g+s),s.includes("import")?`${s}`:`import '${s}';`):Array.isArray(s)?s.map(r=>(r.startsWith("./")&&(r=g+r),r.includes("import")?r:`import '${r}';`)).join(`
`):typeof s=="object"?Object.entries(s).map(([n,l])=>(n.startsWith("./")&&(n=g+n),typeof l=="string"?`import ${l} from '${n}';`:typeof l=="boolean"&&l?`import '${n}'`:`import { ${Object.entries(l).map(([u,y])=>typeof y=="string"?`${u} as ${y}`:u).join(", ")} } from '${n}';`)).join(`
`)+"":""}function k(s,R,g){let r=new MessageChannel;s.id||(s.id=Math.random()),R.id||(R.id=Math.random()),s.postMessage({COMMAND:{SENDER:r.port1,id:R.id,blocking:g}},[r.port1]),R.postMessage({COMMAND:{RECEIVER:r.port2,id:s.id,blocking:g}},[r.port2]),s.PORTS||(s.PORTS=[]),s.PORTS.push(R),R.PORTS||(R.PORTS=[]),R.PORTS.push(s)}var L=(s=()=>{})=>{globalThis.WORKER={},s=s.bind(globalThis.WORKER);let R=(r,n,l,f)=>{if(globalThis.WORKER.SENDERS&&f!==true)if(f!==void 0&&f!=="both")globalThis.WORKER.SENDERS[f]&&(r?.message?globalThis.WORKER.SENDERS[f].postMessage({message:r.message,overridePort:r?.overridePort},r.transfer):globalThis.WORKER.SENDERS[f].postMessage({message:r,overridePort:r?.overridePort}));else{for(let u in globalThis.WORKER.SENDERS){if(globalThis.WORKER.BLOCKING[u]){if(globalThis.WORKER.BLOCKED[u]){console.error("Thread Blocked: "+u);continue}globalThis.WORKER.BLOCKED[u]=true}r?.message?globalThis.WORKER.SENDERS[u].postMessage({message:r.message,overridePort:r?.overridePort},r.transfer):globalThis.WORKER.SENDERS[u].postMessage({message:r,overridePort:r?.overridePort})}l&&postMessage(true)}(!globalThis.WORKER.SENDERS||f===true||f==="both")&&(r?.message?postMessage({message:r.message,cb:n,overridePort:r?.overridePort},r.transfer):postMessage({message:r,cb:n,overridePort:r?.overridePort}))},g=(r,n)=>{let l=s(r.data?.message);l?.then?l.then(f=>{n&&n.postMessage(true),R(f,r.data.cb,r.data.oneOff,r.data.overridePort)}):(n&&n.postMessage(true),R(l,r.data.cb,r.data.oneOff,r.data.overridePort))};globalThis.onmessage=r=>{if(r.data?.COMMAND){let n=r.data.COMMAND;if(typeof n.SETLOOP=="number"){globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP);let l=()=>{g(r),globalThis.WORKER.LOOP=setTimeout(()=>{l()},n.SETLOOP)};l()}if(n.SETANIM){globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM);let l=()=>{g(r),globalThis.WORKER.ANIM=requestAnimationFrame(()=>{l()})};l()}if(n.STOP&&(globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP),globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM)),n.RECEIVER){let l=n.blocking;globalThis.WORKER.RECEIVERS||(globalThis.WORKER.RTCR=0,globalThis.WORKER.RECEIVERS={});let f=n.id;globalThis.WORKER.RECEIVERS[f]=n.RECEIVER,globalThis.WORKER.RTCR++,n.RECEIVER.onmessage=u=>{g(u,l?n.RECEIVER:void 0)},n.RECEIVER.onerror=u=>{delete globalThis.WORKER.RECEIVERS[f]}}if(n.SENDER){globalThis.WORKER.SENDERS||(globalThis.WORKER.PCTR=0,globalThis.WORKER.SENDERS={},globalThis.WORKER.BLOCKING={},globalThis.WORKER.BLOCKED={});let l=n.blocking,f=n.id?n.id:globalThis.WORKER.PCTR;globalThis.WORKER.SENDERS[f]=n.SENDER,globalThis.WORKER.PCTR++,l&&(globalThis.WORKER.BLOCKING[f]=true),n.SENDER.onmessage=u=>{globalThis.WORKER.BLOCKING[f]&&(globalThis.WORKER.BLOCKED[f]=false)},n.SENDER.onerror=u=>{delete globalThis.WORKER.SENDERS[f]}}n.DELETED&&(delete globalThis.WORKER.RECEIVERS?.[n.DELETED],delete globalThis.WORKER.SENDERS?.[n.DELETED])}else g(r)},globalThis.onerror=r=>{console.error(r)}};var N=L.toString();var I=(s,R)=>{let g=N.replace("()=>{}",s.toString()),n=`${D(R)}

(${g})()`,l=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(l)};var A=C;function C2(i=W=>W,{imports:u,message:g,transfer:r,port:n,blocking:l,pool:f,loop:d,animate:y,callback:P}={}){return new Promise((W,S)=>{let O;if(typeof i!="function"){if(typeof i=="string"&&i.startsWith("./")){let s=location.origin,o=location.pathname.split("/");o.pop();let c=o.join("/");c.startsWith("http")?s+="/":s+=c+"/",i=s+i}O=i}else O=I2(i,u);let M=s=>{let o={},c=false;s.onmessage=a=>{for(let e in o)o[e](a.data.message,a.data.cb)},s.onerror=a=>{console.error(new Error("Worker encountered an error: "+a.message))};let R=(a,e,t)=>new Promise((b,p2)=>{if(!t&&s.PORTS)s.postMessage({message:a,overridePort:t},e),b(true);else{if(l){if(c)return new Promise((h,T)=>{T("Thread Blocked")});c=true}let E=Math.random();o[E]=(h,T)=>{E===T&&(delete o[E],l&&(c=false),b(h))},s.postMessage({message:a,cb:E,overridePort:t},e)}}),m={run:(a,e,t)=>R(a,e,t),terminate:()=>{if(URL.revokeObjectURL(O),s.terminate(),s.PORTS){let a=(e,t)=>{e.postMessage({COMMAND:{DELETED:s.id}})};s.PORTS.forEach(a)}},addPort:a=>k2(s,a,l),addCallback:(a=t=>{},e)=>{let t=Math.random();return o[t]=e?b=>{a(b),delete o[t]}:a,t},removeCallback:a=>{delete m.callbacks[a]},setLoop:(a,e,t)=>{s.postMessage({message:e,COMMAND:{SETLOOP:a}},t)},setAnimation:(a,e)=>{s.postMessage({message:a,COMMAND:{SETANIM:true}},e)},stop:()=>{s.postMessage({COMMAND:{STOP:true}})},worker:s,callbacks:o,id:s.id};return P&&m.addCallback(P),d?m.setLoop(d,g,r):y&&m.setAnimation(g,r),m};if(f){let c=function(){let m=new Worker(O,u||typeof i!="function"?{type:"module"}:void 0),a=Math.random();return m.id=a,s[a]=m,a},s={},o={};for(let m=0;m<f;m++)c();let R=Object.keys(s);if(n&&R.forEach((m,a)=>{let e=s[m];Array.isArray(n)?n.length===R.length?k2(e,n[a],l):n.forEach(t=>{k2(e,t,l)}):k2(e,n,l)}),g&&!d&&!y)Promise.all(R.map((m,a)=>{let e=s[m],t=Array.isArray(g)?g[a]:g;return new Promise((b,p2)=>{e.onmessage=h=>{Promise.resolve().then(()=>{e.terminate(),delete s[e.id]}),b(h.data.message)},e.onerror=h=>{Promise.resolve().then(()=>{e.terminate(),delete s[e.id]}),p2(new Error("Worker encountered an error: "+h.message))};let E={message:t,oneOff:true};e.postMessage(E,r)})})).then(m=>{URL.revokeObjectURL(O),W(m)}).catch(m=>{URL.revokeObjectURL(O),Object.keys(s).map((a,e)=>{let t=s[a];t&&t.terminate(),delete s[a],delete o.helpers?.[a]}),S(m)});else{let m=0;Object.assign(o,{workers:s,helpers:{},keys:R,run:(e,t,b,p2)=>{if(p2)return o.helpers[p2]?.run(e,t);if(Array.isArray(e)){let E=e.length,h=[];for(let T=0;T<E;T++){let K=o.helpers[R[m]].run(e[T],t[T],b);m++,m>=R.length&&(m=0),h.push(K)}return h}else{let E=o.helpers[R[m]].run(e,t,b);return m++,m>=R.length&&(m=0),E}},terminate:e=>{function t(b){o.helpers[b]?.terminate(),delete o.helpers[b],delete o.workers[b]}e?t(e):R.forEach(t)},addWorker:()=>{let e=c(),t=s[e];return a(t),R.length=0,R.push(...R),e},addPort:(e,t)=>{function b(p2){return o.helpers[p2]?.addPort(e),true}return t?b(t):R.map(b)},addCallback:(e,t,b)=>{function p2(E){return o.helpers[E]?.addCallback(e,t)}return b?p2(b):R.map(p2)},removeCallback:(e,t)=>{function b(p2){return o.helpers[p2]?.removeCallback(e),true}return t?b(t):R.map(b)},setLoop:(e,t,b,p2)=>{function E(h){o.helpers[h]?.setLoop(e,t,b)}return p2?E(p2):R.map(E)},setAnimation:(e,t,b)=>{function p2(E){o.helpers[E]?.setAnimation(e,t)}return b?p2(b):R.map(p2)},stop:e=>{function t(b){o.helpers[b]?.stop()}return e?t(e):R.map(t)}});let a=e=>{o.helpers[e.id]=M(e)};Object.keys(s).forEach((e,t)=>{a(s[e])}),W(o)}}else{let s=Math.random(),o=new Worker(O,u||typeof i!="function"?{type:"module"}:void 0);if(o.id=s,n&&(n.id||(n.id=Math.random()),Array.isArray(n)?n.map(c=>{k2(o,c,l)}):k2(o,n,l)),g&&!d&&!y)o.onmessage=c=>{Promise.resolve().then(()=>{o.terminate(),URL.revokeObjectURL(O)}),W(c.data.message)},o.onerror=c=>{Promise.resolve().then(()=>{o.terminate(),URL.revokeObjectURL(O)}),S(new Error("Worker encountered an error: "+c.message))},o.postMessage({message:g,oneOff:true},r);else{let c=M(o);W(c)}}})}function D2(i){let u=location.pathname.split("/");u.pop();let g=location.origin+u.join("/")+"/";return typeof i=="string"?(i.startsWith("./")&&(i=g+i),i.includes("import")?`${i}`:`import '${i}';`):Array.isArray(i)?i.map(r=>(r.startsWith("./")&&(r=g+r),r.includes("import")?r:`import '${r}';`)).join(`
`):typeof i=="object"?Object.entries(i).map(([n,l])=>(n.startsWith("./")&&(n=g+n),typeof l=="string"?`import ${l} from '${n}';`:typeof l=="boolean"&&l?`import '${n}'`:`import { ${Object.entries(l).map(([d,y])=>typeof y=="string"?`${d} as ${y}`:d).join(", ")} } from '${n}';`)).join(`
`)+"":""}function k2(i,u,g){let r=new MessageChannel;i.id||(i.id=Math.random()),u.id||(u.id=Math.random()),i.postMessage({COMMAND:{SENDER:r.port1,id:u.id,blocking:g}},[r.port1]),u.postMessage({COMMAND:{RECEIVER:r.port2,id:i.id,blocking:g}},[r.port2]),i.PORTS||(i.PORTS=[]),i.PORTS.push(u),u.PORTS||(u.PORTS=[]),u.PORTS.push(i)}var L2=(i=()=>{})=>{globalThis.WORKER={};let u=(r,n,l,f)=>{if(globalThis.WORKER.SENDERS&&f!==true)if(f!==void 0&&f!=="both")globalThis.WORKER.SENDERS[f]&&(r?.message?globalThis.WORKER.SENDERS[f].postMessage({message:r.message,overridePort:r?.overridePort},r.transfer):globalThis.WORKER.SENDERS[f].postMessage({message:r,overridePort:r?.overridePort}));else{for(let d in globalThis.WORKER.SENDERS){if(globalThis.WORKER.BLOCKING[d]){if(globalThis.WORKER.BLOCKED[d]){console.error("Thread Blocked: "+d);continue}globalThis.WORKER.BLOCKED[d]=true}r?.message?globalThis.WORKER.SENDERS[d].postMessage({message:r.message,overridePort:r?.overridePort},r.transfer):globalThis.WORKER.SENDERS[d].postMessage({message:r,overridePort:r?.overridePort})}l&&postMessage(true)}(!globalThis.WORKER.SENDERS||f===true||f==="both")&&(r?.message?postMessage({message:r.message,cb:n,overridePort:r?.overridePort},r.transfer):postMessage({message:r,cb:n,overridePort:r?.overridePort}))},g=(r,n)=>{let l=i(r.data?.message);l?.then?l.then(f=>{n&&n.postMessage(true),u(f,r.data.cb,r.data.oneOff,r.data.overridePort)}):(n&&n.postMessage(true),u(l,r.data.cb,r.data.oneOff,r.data.overridePort))};globalThis.onmessage=r=>{if(r.data?.COMMAND){let n=r.data.COMMAND;if(typeof n.SETLOOP=="number"){globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP);let l=()=>{g(r),globalThis.WORKER.LOOP=setTimeout(()=>{l()},n.SETLOOP)};l()}if(n.SETANIM){globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM);let l=()=>{g(r),globalThis.WORKER.ANIM=requestAnimationFrame(()=>{l()})};l()}if(n.STOP&&(globalThis.WORKER.LOOP&&clearTimeout(globalThis.WORKER.LOOP),globalThis.WORKER.ANIM&&cancelAnimationFrame(globalThis.WORKER.ANIM)),n.RECEIVER){let l=n.blocking;globalThis.WORKER.RECEIVERS||(globalThis.WORKER.RTCR=0,globalThis.WORKER.RECEIVERS={});let f=n.id;globalThis.WORKER.RECEIVERS[f]=n.RECEIVER,globalThis.WORKER.RTCR++,n.RECEIVER.onmessage=d=>{g(d,l?n.RECEIVER:void 0)},n.RECEIVER.onerror=d=>{delete globalThis.WORKER.RECEIVERS[f]}}if(n.SENDER){globalThis.WORKER.SENDERS||(globalThis.WORKER.PCTR=0,globalThis.WORKER.SENDERS={},globalThis.WORKER.BLOCKING={},globalThis.WORKER.BLOCKED={});let l=n.blocking,f=n.id?n.id:globalThis.WORKER.PCTR;globalThis.WORKER.SENDERS[f]=n.SENDER,globalThis.WORKER.PCTR++,l&&(globalThis.WORKER.BLOCKING[f]=true),n.SENDER.onmessage=d=>{globalThis.WORKER.BLOCKING[f]&&(globalThis.WORKER.BLOCKED[f]=false)},n.SENDER.onerror=d=>{delete globalThis.WORKER.SENDERS[f]}}n.DELETED&&(delete globalThis.WORKER.RECEIVERS?.[n.DELETED],delete globalThis.WORKER.SENDERS?.[n.DELETED])}else g(r)},globalThis.onerror=r=>{console.error(r)}};var N2=L2.toString();var I2=(i,u)=>{let g=N2.replace("()=>{}",i.toString()),n=`${D2(u)}

(${g})()`,l=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(l)};function mapBitmapXIntensities(ImageDataUint8,width,height){const data=new Uint32Array(ImageDataUint8.buffer);const i=new Float32Array(width);const r=new Float32Array(width);const g=new Float32Array(width);const b=new Float32Array(width);let maxR=0,maxG=0,maxB=0;for(let index=0;index<data.length;index++){const x=index%width;const rgba=data[index];const red=rgba&255;const green=rgba>>8&255;const blue=rgba>>16&255;i[x]+=red+green+blue;r[x]+=red;g[x]+=green;b[x]+=blue;maxR=r[x]>maxR?r[x]:maxR;maxG=g[x]>maxG?g[x]:maxG;maxB=b[x]>maxB?b[x]:maxB}const intensities=new Array(width);let max=maxR+maxG+maxB;for(let x=0;x<width;x++){intensities[x]={i:i[x]/max,r:r[x]/max,g:g[x]/max,b:b[x]/max}}return{intensities,width,height,maxR,maxG,maxB}}function graphXIntensities(context,xrgbintensities,width,height,x0=0,y0=0){context.lineWidth=2;const drawLine=(channelData,strokeStyle)=>{context.beginPath();context.strokeStyle=strokeStyle;channelData.forEach((value,i)=>{const x=x0+i*(width/channelData.length);const y=y0+height*(1-value);i===0?context.moveTo(x,y):context.lineTo(x,y)});context.stroke()};drawLine(xrgbintensities.map(y=>y.i),"ghostwhite");drawLine(xrgbintensities.map(y=>y.r),"tomato");drawLine(xrgbintensities.map(y=>y.g),"chartreuse");drawLine(xrgbintensities.map(y=>y.b),"#00b8f5");return{xrgbintensities,width,height}}var autocorrelateImageThreadedPool;async function autocorrelateImageThreaded(ImageDataUint8,imageWidth,imageHeight){const redChannel=new Uint8Array(imageWidth*imageHeight);const greenChannel=new Uint8Array(imageWidth*imageHeight);const blueChannel=new Uint8Array(imageWidth*imageHeight);for(let i=0,j=0;i<ImageDataUint8.length;i+=4,j++){redChannel[j]=ImageDataUint8[i];greenChannel[j]=ImageDataUint8[i+1];blueChannel[j]=ImageDataUint8[i+2]}const autocorrelateSegment=({channelData,imageWidth:imageWidth2,imageHeight:imageHeight2})=>{const result=new Uint8Array(imageWidth2*imageHeight2);for(let y=0;y<imageHeight2;y++){for(let x=0;x<imageWidth2;x++){let G=0;const idx=y*imageWidth2+x;for(let b=0;b<imageHeight2;b++){for(let a=0;a<imageWidth2;a++){const otherIdx=b*imageWidth2+a;G+=channelData[idx]*channelData[otherIdx]}}result[idx]=G}}console.log("running autocor");return result};if(!autocorrelateImageThreadedPool)autocorrelateImageThreadedPool=await C2(autocorrelateSegment,{pool:3});let runs=[autocorrelateImageThreadedPool.run({channelData:redChannel,imageWidth,imageHeight},[redChannel.buffer]),autocorrelateImageThreadedPool.run({channelData:greenChannel,imageWidth,imageHeight},[greenChannel.buffer]),autocorrelateImageThreadedPool.run({channelData:blueChannel,imageWidth,imageHeight},[blueChannel.buffer])];const[redResult,greenResult,blueResult]=await Promise.all(runs);const reconstructed=new Uint8Array(imageWidth*imageHeight*4);for(let i=0,j=0;i<redResult.length;i++,j+=4){reconstructed[j]=redResult[i];reconstructed[j+1]=greenResult[i];reconstructed[j+2]=blueResult[i];reconstructed[j+3]=255}return new Uint8ClampedArray(reconstructed)}async function initVideoProcessingThreads(decoderPool=4,modelName="inception-mnist.onnx",labelsName="mnist-labels.txt",inputName="input",outputName="output",outputWidth=64,outputHeight=64){const classifierThread=await A("./dist/wonnx.worker.js");classifierThread.run({command:"configure",modelName,labelsName,inputName,outputName,outputWidth,outputHeight});const canvasThread=await A(function(data){if(!data)return;if(data.canvas){if(!this.canvases){this.canvases={};this.contexts={}}this.canvases[data.cropIndex]=data.canvas;let ctx=data.canvas.getContext("2d");this.contexts[data.cropIndex]=ctx}if("draw"in data&&this.canvases?.[data.cropIndex]){if(data.width){this.canvases[data.cropIndex].width=data.width}if(data.height){this.canvases[data.cropIndex].height=data.height}this.contexts[data.cropIndex]?.drawImage(data.image,0,0,this.canvases[data.cropIndex].width,this.canvases[data.cropIndex].height)}else if("drawSpectral"in data&&this.canvases?.[data.cropIndex]&&data.spectral){if(data.width){this.canvases[data.cropIndex].width=data.width}if(data.height){this.canvases[data.cropIndex].height=data.height}graphXIntensities(this.contexts[data.cropIndex],data.spectral?.intensities,data.width,data.height)}else if("delete"in data&&this.canvases[data.cropIndex]){this.contexts[data.cropIndex].clearRect(0,0,this.canvases[data.cropIndex].width,this.canvases[data.cropIndex].height);delete this.canvases[data.cropIndex];delete this.contexts[data.cropIndex]}return true},{imports:{["./src/lib/imagemanip.js"]:{"graphXIntensities":true}}});const poolingThread=await A(async function(input){if(input.command?.includes("set")&&input.data){input.data.forEach(imgData=>{if(!imgData)return;if(!this.TempCaptures){this.TempCaptures={};this.TempImageData={};this.TempACorRawData={};this.TempACorImageData={};this.TempSpectralData={};this.bufferLimit=100;this.bufferOrder=[]}this.bufferOrder.push(imgData.name);if(this.bufferOrder.length>this.bufferLimit){delete this.TempCaptures[this.bufferOrder[0]];delete this.TempImageData[this.bufferOrder[0]];delete this.TempACorRawData[this.bufferOrder[0]];delete this.TempACorImageData[this.bufferOrder[0]];delete this.TempSpectralData[this.bufferOrder[0]];this.bufferOrder.shift()}this.TempImageData[imgData.name]=imgData.bmp;this.TempSpectralData[imgData.name]=imgData.spectral;this.TempACorRawData[imgData.name]=imgData.autocor;this.TempACorImageData[imgData.name]=imgData.autocorbmp;delete imgData.bmp;delete imgData.spectral;delete imgData.autocor;delete imgData.autocorbmp;this.TempCaptures[imgData.name]=imgData});return input.id}else if(input.command?.includes("getbmp")&&input.name){const capture=this.TempCaptures[input.name];const imgData=this.TempImageData[input.name];if(!imgData||!capture)return;return await new Promise((res,rej)=>{createImageBitmap(imgData,0,0,capture.width,capture.height).then(bmp=>{let captureCpy=Object.assign({draw:true},capture,{image:bmp});res({message:captureCpy,transfer:[bmp]})}).catch(rej)})}else if(input.command?.includes("getautocorbmp")&&input.name){const capture=this.TempCaptures[input.name];const imgData=this.TempACorImageData[input.name];if(!imgData||!capture)return;return await new Promise((res,rej)=>{createImageBitmap(imgData,0,0,capture.width,capture.height).then(bmp=>{let captureCpy=Object.assign({draw:true},capture,{image:bmp});res({message:captureCpy,transfer:[bmp]})}).catch(rej)})}else if(input.command?.includes("getautocor")&&input.name){const captureCpy=Object.assign({},this.TempCaptures[input.name]);if(!captureCpy||!this.TempACorRawData[input.name])return;let clone=new Uint8ClampedArray(this.TempACorRawData[input.name].length);clone.set(this.TempACorRawData[input.name]);captureCpy.image=clone;return{message:captureCpy,transfer:[captureCpy.image?.buffer?captureCpy.image.buffer:captureCpy.image]}}else if(input.command?.includes("getspectral")&&input.name){const captureCpy=Object.assign({drawSpectral:true},this.TempCaptures[input.name]);const spectral=this.TempSpectralData[input.name];if(!captureCpy||!spectral)return;captureCpy.spectral=spectral;delete captureCpy.image;captureCpy.cropIndex=captureCpy.cropIndex+"s";return{message:captureCpy}}else if(input.command?.includes("get")&&input.name){const captureCpy=Object.assign({},this.TempCaptures[input.name]);if(!captureCpy?.image)return;let clone=new Uint8ClampedArray(captureCpy.image.length);clone.set(captureCpy.image);captureCpy.image=clone;return{message:captureCpy,transfer:[captureCpy.image?.buffer?captureCpy.image.buffer:captureCpy.image]}}},{port:[classifierThread.worker,canvasThread.worker]});const videoDecoderThread=await A(async function(input){let image;if(input.image?.buffer){image=new ImageData(input.image,input.width,input.height)}else image=input.image;let result=[];for(let i=0;i<input.data.length;i++){const data=input.data[i];if(!data)return;if(!this.offscreen){this.offscreen=new OffscreenCanvas(data.outputWidth||data.cropW||input.width,data.outputHeight||data.cropH||input.height);this.backupOffscreen=new OffscreenCanvas(input.width,input.height);this.ctx=this.offscreen.getContext("2d",{willReadFrequently:true});this.bctx=this.backupOffscreen.getContext("2d",{willReadFrequently:true})}else{this.offscreen.width=data.outputWidth||data.cropW||input.width;this.offscreen.height=data.outputHeight||data.cropH||input.height}let bmp;if(image instanceof VideoFrame){this.ctx.drawImage(image,data.cropX||0,data.cropY||0,data.cropW||input.width,data.cropH||input.height,0,0,this.offscreen.width,this.offscreen.height);if(i===input.data.length-1)image.close()}else{this.backupOffscreen.width=input.width;this.backupOffscreen.height=input.height;this.bctx.putImageData(image,0,0);this.ctx.drawImage(this.backupOffscreen,data.cropX||0,data.cropY||0,data.cropW||input.width,data.cropH||input.height,0,0,this.offscreen.width,this.offscreen.height)}let prom=createImageBitmap(this.offscreen);let scaledData=this.ctx.getImageData(0,0,this.offscreen.width,this.offscreen.height).data;let acor;if(input.autocor){acor=autocorrelateImageThreaded(scaledData,this.offscreen.width,this.offscreen.height)}bmp=await prom;let crop={...data,bmp,image:scaledData,width:this.offscreen.width,height:this.offscreen.height};let transfer=[crop.image.buffer,bmp];if(input.autocor){crop.autocor=await acor;crop.autocorbmp=await createImageBitmap(new ImageData(crop.autocor,this.offscreen.width,this.offscreen.height));transfer.push(crop.autocor.buffer,crop.autocorbmp)}if(input.spectral){crop.spectral=mapBitmapXIntensities(scaledData,this.offscreen.width,this.offscreen.height)}result.push({message:crop,transfer})}let output={message:{data:[],command:input.command,id:input.id},transfer:[],overridePort:input.overridePort};result.forEach(value=>{if(!value)return;output.message.data.push(value.message);output.transfer.push(...value.transfer)});return output},{imports:{["./src/lib/imagemanip.js"]:{"autocorrelateImageThreaded":true,"autocorrelateImage":true,"mapBitmapXIntensities":true}},port:[poolingThread.worker],pool:decoderPool});return{canvasThread,videoDecoderThread,poolingThread,classifierThread}}var CSV=class{constructor(onOpen=this.onOpen,saveButtonId=null,openButtonId=null){this.onOpen=onOpen;this.notes=[];if(saveButtonId!==null){document.getElementById(saveButtonId).addEventListener("click",this.saveCSV)}if(openButtonId!==null){document.getElementById(openButtonId).addEventListener("click",this.openCSV)}}processArraysForCSV(data=["1|2|3","3|2|1"],delimiter="|",header="a,b,c",saveNotes=false){let csvDat=header+"\n";let noteIdx=0;data.forEach((line,i)=>{if(data[i]==="string"&&delimiter!==","){csvDat+=line.split(delimiter).join(",")}else{csvData+=line.join(",")}if(saveNotes===true){if(this.notes[noteIdx].idx===i){line+=this.notes[noteIdx].text;noteIdx++}}if(line.indexOf("\n")<0){csvDat+="\n"}});return csvDat}static saveCSV(csvDat="a,b,c\n1,2,3\n3,2,1\n",name=new Date().toISOString()){var hiddenElement=document.createElement("a");hiddenElement.href="data:text/csv;charset=utf-8,"+encodeURI(csvDat);hiddenElement.target="_blank";if(name!==""){hiddenElement.download=name}else{hiddenElement.download=new Date().toISOString()+".csv"}hiddenElement.click()}static openCSV(delimiter=",",onOpen=(csvDat,header,path)=>{return csvDat,header,path}){return new Promise((res,rej)=>{var input=document.createElement("input");input.accept=".csv";input.type="file";input.onchange=e=>{var file=e.target.files[0];var reader=new FileReader;reader.onload=event=>{var tempcsvData=event.target.result;var tempcsvArr=tempcsvData.split("\n");let header=[];var csvDat=[];tempcsvArr.pop();tempcsvArr.forEach((row,i)=>{if(i==0){header=row.split(delimiter)}else{var temp=row.split(delimiter);csvDat.push(temp)}});onOpen(csvDat,header,input.value);input.value="";res({data:csvDat,header,filename:input.value})};reader.readAsText(file)};input.click()})}static openCSVRaw(onOpen=(csvDat,path)=>{return csvDat,path}){return new Promise((res,rej)=>{var input=document.createElement("input");input.accept=".csv";input.type="file";input.onchange=e=>{var file=e.target.files[0];var reader=new FileReader;reader.onload=event=>{var tempcsvData=event.target.result;onOpen(tempcsvData,input.value);input.value="";res({data:tempcsvData,filename:input.value})};reader.readAsText(file)};input.click()})}onOpen(csvDat=[],header=[]){console.log("CSV Opened!",header,csvDat)}};var ImageProcessor=class{id;Media;BBTool;threads;parentElement;container;streamVideo;useSpectralAnalysis;useAutocor;outputWidth;outputHeight;poolCt=0;poolCtMaxIdx=3;threadRunning=false;classifierWait;classifierResults;canvasPool=[];animation;constructor(parentElement=document.body,modelInpWidth=224,modelInpHeight=224,threadSettings){this.parentElement=parentElement;this.id=Math.random();const oncreate=(id,element)=>{console.log("Image, stream or video created with ID or URL:",id)};const onstarted=(id,element)=>{console.log("Stream or video started with ID or URL:",id)};const ondelete=(id,element)=>{console.log("Media element removed with ID or URL:",id)};const ontargetchanged=(id,element)=>{this.BBTool?.clearBoundingBoxes(true);this.BBTool=new BoundingBoxTool(element,{color:"orange",labelColor:"orange",oncreate:(box,boxes)=>{console.log("Created",box,boxes)},onedited:(box,boxes)=>{},ondelete:(box,boxes)=>{console.log("Deleted",box,boxes)}});this.clearCanvases();setTimeout(()=>{const textElm=document.getElementById("mediaDims"+this.id);textElm.innerText=`${element.videoWidth||element.naturalWidth||element.width}x${element.videoHeight||element.naturalHeight||element.height}`},300);console.log("Stream target changed with ID or URL:",id)};this.parentElement.insertAdjacentHTML("beforeend",`
            <div id="container${this.id}" class="image-processor-container">
                <div id="mediaElm${this.id}" class="image-processor-camera">
                    <span id="mediaDims${this.id}" class="image-processor-dimensions-label"></span>
                </div>
                <div id="controls${this.id}" class="image-processor-controls">
                    <button id="capture${this.id}" class="image-processor-capture-btn">\u{1F4F7}</button>
                    <div class="image-processor-checkboxes">
                        <label for="streamvideo${this.id}">
                            <input type="checkbox" id="streamvideo${this.id}" name="streamvideo">
                            Stream Video
                        </label>
                        <label for="spectral${this.id}">
                            <input type="checkbox" id="spectral${this.id}" name="spectral">
                            Spectral
                        </label>
                        <label for="autocorrelate${this.id}">
                            <input type="checkbox" id="autocorrelate${this.id}" name="autocorrelate">
                            Autocorrelated
                        </label>
                    </div>
                </div>
                <div id="results${this.id}" class="image-processor-results"></div>
                <div id="workspace${this.id}" class="image-processor-workspace"></div>
            </div>
        `);this.container=document.getElementById(`container${this.id}`);this.streamVideo=document.getElementById(`streamvideo${this.id}`);this.useSpectralAnalysis=document.getElementById(`spectral${this.id}`);this.useAutocor=document.getElementById(`autocorrelate${this.id}`);let animating=false;this.streamVideo.onchange=()=>{if(this.streamVideo.checked){animating=true;const anim=async()=>{if(!animating)return;await this.processBoundingBoxes();this.animation=requestAnimationFrame(anim)};this.animation=requestAnimationFrame(anim)}else if(this.animation){animating=false;cancelAnimationFrame(this.animation)}};this.useSpectralAnalysis.onchange=()=>{if(!document.getElementById("savespectrum0"))return;if(this.useSpectralAnalysis.checked){document.getElementById("savespectrum0").style.display="";document.getElementById("savespectrumcsv0").style.display="";document.getElementById("canvas20").style.display="";this.BBTool.boxes.forEach((b,i)=>{if(i===0)return;document.getElementById("savespectrum"+i).style.display="";document.getElementById("savespectrumcsv"+i).style.display="";document.getElementById("canvas2"+i).style.display=""})}else{document.getElementById("savespectrum0").style.display="none";document.getElementById("savespectrumcsv0").style.display="none";document.getElementById("canvas20").style.display="none";this.BBTool.boxes.forEach((b,i)=>{document.getElementById("savespectrum"+i).style.display="none";document.getElementById("savespectrumcsv"+i).style.display="none";document.getElementById("canvas2"+i).style.display="none"})}};this.Media=new MediaElementCreator(document.getElementById(`mediaElm${this.id}`),{oncreate,onstarted,ondelete,ontargetchanged});this.outputWidth=modelInpWidth;this.outputHeight=modelInpHeight;this.initThreads(modelInpWidth,modelInpHeight,threadSettings);const captureButton=document.getElementById("capture"+this.id);captureButton.onclick=()=>{captureButton.classList.add("capture-btn-active");this.processBoundingBoxes();captureButton.addEventListener("animationend",()=>{captureButton.classList.remove("capture-btn-active")})}}async initThreads(outputWidth,outputHeight,{decoderPool=4,modelName="opt-squeeze.onnx",labelsName="squeeze-labels.txt",inputName="data",outputName="squeezenet0_flatten0_reshape0"}={}){this.threads=await initVideoProcessingThreads(decoderPool,modelName,labelsName,inputName,outputName,outputWidth,outputHeight);this.threads.classifierThread.addCallback(res=>{if(!res)return;console.timeEnd(`capture and inference ${res.name}`);this.visualizeCapture(res);this.poolCt--});this.threads.videoDecoderThread.addCallback(res=>{});this.threads.poolingThread.addCallback(res=>{})}clearCanvases=()=>{for(let i=0;i<this.canvasPool.length;i++){this.threads.canvasThread.run({cropIndex:i,delete:true});document.getElementById("div"+i)?.remove()}this.canvasPool=[]};deinit(){for(const key in this.threads){this.threads[key].terminate()}this.container.remove()}getOrCreateCanvas(crop){if(this.canvasPool[crop.cropIndex]){let canvas=this.canvasPool[crop.cropIndex];return canvas}else{let canvas=document.createElement("canvas");canvas.id="canvas"+crop.cropIndex;canvas.width=crop.outputWidth;canvas.height=crop.outputHeight;this.canvasPool.push(canvas);canvas.style.maxWidth="150px";canvas.style.maxHeight="150px";let offscreen=canvas.transferControlToOffscreen();this.threads.canvasThread.run({canvas:offscreen,cropIndex:crop.cropIndex},[offscreen]);let canvas2=document.createElement("canvas");canvas2.id="canvas2"+crop.cropIndex;canvas2.width=crop.outputWidth;canvas2.height=crop.outputHeight;canvas2.style.maxWidth="150px";canvas2.style.maxHeight="150px";canvas2.style.position="absolute";let offscreen2=canvas2.transferControlToOffscreen();this.threads.canvasThread.run({canvas:offscreen2,cropIndex:crop.cropIndex+"s"},[offscreen2]);let canvasDiv=document.createElement("div");canvasDiv.id="div"+crop.cropIndex;canvasDiv.innerHTML=`
                <table class="image-processor-table">
                    <tr>
                        <td class="image-processor-media" id="canvasContainer${crop.cropIndex}">
                            <span class="image-processor-dimensions-label">${crop.outputWidth}x${crop.outputHeight}</span>
                        </td>
                        <td id="output${crop.cropIndex}">
                            <table class="image-processor-table">
                                <tr id="imgheaderrow${crop.cropIndex}"  class="image-processor-table-header">
                                    <td colSpan="2" class="image-processor-table-cell">
                                        <input type="text" id="name${crop.cropIndex}" placeholder="Image Name"> .png
                                    </td>
                                    <td id="imgheadercell${crop.cropIndex}" class="image-processor-table-cell"></td>
                                </tr>
                                <tr>
                                    <th>Best Guess:</th>
                                    <th>Probability:</th>
                                    <th>ONNX Time (ms):</th>
                                </tr>
                                <tr class="image-processor-table-row">
                                    <td id="label${crop.cropIndex}" class="image-processor-table-cell"></td>
                                    <td id="maxProb${crop.cropIndex}" class="image-processor-table-cell"></td>
                                    <td id="inferenceTime${crop.cropIndex}" class="image-processor-table-cell"></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            `;let dimensionsLabel=document.createElement("div");document.getElementById(`results${this.id}`).appendChild(canvasDiv);document.getElementById(`canvasContainer${crop.cropIndex}`).appendChild(canvas);document.getElementById(`canvasContainer${crop.cropIndex}`).appendChild(canvas2);document.getElementById(`canvasContainer${crop.cropIndex}`).appendChild(dimensionsLabel);canvas2.style.left="0px";canvas2.style.display=this.useSpectralAnalysis.checked?"":"none";let appendTo=document.getElementById("imgheadercell"+crop.cropIndex);let downloadDiv=document.createElement("div");let downloadBtn=document.createElement("button");downloadBtn.id="save"+crop.cropIndex;downloadBtn.innerHTML="\u{1F4BE}";downloadBtn.addEventListener("click",()=>this.downloadCanvas("canvas"+crop.cropIndex,crop.cropIndex));downloadBtn.title="Download Image";let downloadSpectrumBtn=document.createElement("button");downloadSpectrumBtn.id="savespectrum"+crop.cropIndex;downloadSpectrumBtn.innerHTML="\u{1F4BE}\u{1F308}";downloadSpectrumBtn.addEventListener("click",()=>{this.downloadCanvas("canvas2"+crop.cropIndex,crop.cropIndex)});downloadSpectrumBtn.style.display=this.useSpectralAnalysis.checked?"":"none";downloadSpectrumBtn.title="Download Spectrum Image";let downloadSpectrumCSVBtn=document.createElement("button");downloadSpectrumCSVBtn.id="savespectrumcsv"+crop.cropIndex;downloadSpectrumCSVBtn.innerHTML="\u{1F4BE}\u{1F4C9}";downloadSpectrumCSVBtn.addEventListener("click",()=>{downloadSpectrumCSV()});downloadSpectrumCSVBtn.style.display=this.useSpectralAnalysis.checked?"":"none";downloadSpectrumCSVBtn.title="Download Spectrum CSV";let downloadSpectrumCSV=async()=>{let result=await this.threads.poolingThread.run({command:"getspectral",name:crop.name},void 0,true);if(!result?.spectral)return;const spectralData=result.spectral;let csvName=document.getElementById(`name${crop.cropIndex}`).value||"image_"+new Date().toISOString();let processed="Intensity,R,G,B\n";for(const value of spectralData.i){processed+=`${spectralData.i},${spectralData.r},${spectralData.g},${spectralData.b}
`}CSV.saveCSV(processed,csvName)};downloadDiv.appendChild(downloadBtn);downloadDiv.appendChild(downloadSpectrumBtn);downloadDiv.appendChild(downloadSpectrumCSVBtn);appendTo.appendChild(downloadDiv)}}downloadCanvas(canvasId,cropIndex){let canvas=document.getElementById(canvasId);if(canvas){let imageName=document.getElementById(`name${cropIndex}`).value||"image_"+new Date().toISOString();canvas.toBlob(blob=>{let link=document.createElement("a");link.download=imageName+".png";link.href=URL.createObjectURL(blob);link.click();URL.revokeObjectURL(link.href)},"image/png")}}clearExcessCanvases=()=>{if(this.canvasPool.length>(this.BBTool.boxes.length||1)){for(let i=this.BBTool.boxes.length||1;i<this.canvasPool.length;i++){this.threads.canvasThread.run({cropIndex:i,delete:true});this.threads.canvasThread.run({cropIndex:i+"s",delete:true});document.getElementById("div"+i)?.remove()}this.canvasPool.length=this.BBTool.boxes.length||1}};getBoundingBoxData=()=>{this.clearExcessCanvases();return this.BBTool.boxes.map((box,i)=>{return{name:box.id+`_${Math.floor(Math.random()*1e15)}`,cropX:box.rect.x,cropY:box.rect.y,cropW:box.rect.width,cropH:box.rect.height,outputWidth:this.outputWidth,outputHeight:this.outputHeight,cropIndex:i}})};processBoundingBoxes=async(data=this.getBoundingBoxData())=>{if(!this.Media.currentMediaElement)return;const timestamp=this.Media.currentMediaElement.currentTime||Date.now();const frame=new VideoFrame(this.Media.currentMediaElement,{timestamp:Date.now()});if(data.length===0){const sourceWidth=this.Media.currentMediaElement.naturalWidth||this.Media.currentMediaElement.videoWidth||this.Media.currentMediaElement.width;const sourceHeight=this.Media.currentMediaElement.naturalHeight||this.Media.currentMediaElement.videoHeight||this.Media.currentMediaElement.height;data.push({name:`${Math.floor(Math.random()*1e15)}`,cropX:0,cropY:0,cropW:sourceWidth,cropH:sourceHeight,outputWidth:this.outputWidth,outputHeight:this.outputHeight,cropIndex:0})}if(this.classifierWait)await this.classifierWait;else if(this.poolCt>=this.poolCtMaxIdx){this.classifierWait=new Promise(res=>{let id2=this.threads.classifierThread.addCallback(()=>{if(this.poolCt===0){this.threads.classifierThread.removeCallback(id2);this.threadRunning=false;this.classifierWait=void 0;res(true)}})});this.threadRunning=true}let toDecode={image:frame,id:`${Math.floor(Math.random()*1e15)}`,width:this.Media.currentMediaElement.videoWidth||this.Media.currentMediaElement.naturalWidth||this.Media.currentMediaElement.width,height:this.Media.currentMediaElement.videoHeight||this.Media.currentMediaElement.naturalHeight||this.Media.currentMediaElement.height,command:"set",timestamp,data,overridePort:true,autocor:this.useAutocor.checked,spectral:this.useSpectralAnalysis.checked};for(const crop of data){console.time(`capture and inference ${crop.name}`);this.poolCt++}let id=this.threads.poolingThread.addCallback(out=>{if(out===toDecode.id){this.threads.poolingThread.removeCallback(id);for(const crop of data){this.getOrCreateCanvas(crop);this.threads.poolingThread.run({command:"get",name:crop.name},void 0,this.threads.classifierThread.id);this.threads.poolingThread.run({command:this.useAutocor.checked?"getautocorbmp":"getbmp",name:crop.name},void 0,this.threads.canvasThread.id);if(this.useSpectralAnalysis.checked){this.threads.poolingThread.run({command:"getspectral",name:crop.name},void 0,this.threads.canvasThread.id)}}}});this.threads.videoDecoderThread.run(toDecode,[frame]);return true};visualizeCapture(classifierResult){if(classifierResult){document.getElementById("name"+classifierResult.cropIndex).value=classifierResult?.name;document.getElementById("label"+classifierResult.cropIndex).innerText=classifierResult?.label;document.getElementById("maxProb"+classifierResult.cropIndex).innerText=classifierResult?.maxProb.toFixed(3);document.getElementById("inferenceTime"+classifierResult.cropIndex).innerText=classifierResult?.inferenceTime.toFixed(3);this.BBTool.updateLabelProgrammatically(classifierResult.name.split("_")[0],classifierResult.label)}}};var url;if(typeof process!=="undefined"){try{if(typeof import.meta!=="undefined"){globalThis.__filename=fileURLToPath(import.meta.url);globalThis.__dirname=fileURLToPath(new URL(".",import.meta.url))}let p2=__require("path");url=p2.join(process.cwd(),__dirname,"wonnx.worker.js")}catch{}}else{let href=globalThis.location.href;let relLoc=href.split("/");relLoc.pop();relLoc=relLoc.join("/");url=relLoc+"/wonnx.worker.js"}var p=new ImageProcessor;
